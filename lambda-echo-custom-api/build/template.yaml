AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Deploys an AWS Lambda function that echos the string passed via an API
  call.
Parameters:
  EnvironmentParameter:
    Type: String
    Default: dev
    AllowedValues:
    - dev
    - test
    - prod
  POCNameParameter:
    Type: String
    Default: Your Name
Globals:
  Function:
    Tags:
      POCName:
        Ref: POCNameParameter
      Environment:
        Ref: EnvironmentParameter
Resources:
  APIGatewayCloudWatchLoggingRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - apigateway.amazonaws.com
          Action: sts:AssumeRole
      Path: /
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs
  Account:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn:
        Fn::GetAtt:
        - APIGatewayCloudWatchLoggingRole
        - Arn
  RestAPI:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name:
        Fn::Join:
        - '-'
        - - Ref: EnvironmentParameter
          - RestAPI
      Description:
        Fn::Join:
        - '-'
        - - Ref: EnvironmentParameter
          - RestAPI
      DisableExecuteApiEndpoint: false
      FailOnWarnings: true
      Tags:
      - Key: Environment
        Value:
          Ref: EnvironmentParameter
  RestAPIResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId:
        Fn::GetAtt:
        - RestAPI
        - RootResourceId
      PathPart: echo
      RestApiId:
        Ref: RestAPI
  RestAPIEchoMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: ANY
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        Uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${EnvironmentParameter}-EchoFunction/invocations
        IntegrationHttpMethod: POST
      ResourceId:
        Ref: RestAPIResource
      RestApiId:
        Ref: RestAPI
  RestAPIDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
    - RestAPIEchoMethod
    Properties:
      Description:
        Fn::Join:
        - '-'
        - - Ref: EnvironmentParameter
          - Ref: RestAPI
          - Deployment
      RestApiId:
        Ref: RestAPI
      StageName:
        Ref: EnvironmentParameter
      StageDescription:
        DataTraceEnabled: true
        Description:
          Fn::Join:
          - '-'
          - - Ref: EnvironmentParameter
            - Ref: RestAPI
            - Stage
        LoggingLevel: INFO
        MetricsEnabled: true
        TracingEnabled: true
        MethodSettings:
        - HttpMethod: '*'
          ResourcePath: /*
          DataTraceEnabled: true
          LoggingLevel: INFO
          MetricsEnabled: false
        Tags:
        - Key: Environment
          Value:
            Ref: EnvironmentParameter
  RestAPILambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: EchoFunction
      Principal: '*'
  EchoFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Join:
        - '-'
        - - Ref: EnvironmentParameter
          - EchoFunction
      Handler: echo.lambda_handler
      Runtime: python3.8
      CodeUri: s3://deployment-it590-us-east-2/sam/3f9a3617f4a1ae2e4941e8d4ab49c34a
      Tracing: Active
      Timeout: 15
      Policies:
      - AWSLambdaExecute
      Environment:
        Variables:
          sqs_queue: message_queue
          sns_topic: message_topic
Outputs:
  EchoApi:
    Description: API Gateway endpoint URL for Prod stage for echo function
    Value:
      Fn::Sub: https://${RestAPI}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentParameter}/echo?message=This
        works!
  EchoFunction:
    Description: Hello World Lambda Function ARN
    Value:
      Fn::GetAtt:
      - EchoFunction
      - Arn
  EchoFunctionIamRole:
    Description: Implicit IAM Role created for Hello World function
    Value:
      Fn::GetAtt:
      - EchoFunctionRole
      - Arn
